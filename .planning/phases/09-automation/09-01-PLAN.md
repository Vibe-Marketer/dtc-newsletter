---
phase: 09-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/newsletter.yml
autonomous: false

user_setup:
  - service: github-secrets
    why: "Pipeline requires API keys stored as repository secrets"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "console.anthropic.com - API Keys"
      - name: TUBELAB_API_KEY
        source: "tubelab.net/developers"
      - name: YOUTUBE_API_KEY
        source: "console.cloud.google.com - YouTube Data API v3"
      - name: PERPLEXITY_API_KEY
        source: "perplexity.ai/settings/api"
      - name: APIFY_TOKEN
        source: "console.apify.com - Settings"
      - name: REDDIT_CLIENT_ID
        source: "reddit.com/prefs/apps"
      - name: REDDIT_CLIENT_SECRET
        source: "reddit.com/prefs/apps"
      - name: REDDIT_USER_AGENT
        source: "Format: dtc-newsletter/1.0 by /u/your_username"
    dashboard_config:
      - task: "Add all 8 secrets to repository"
        location: "GitHub repo Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "Pipeline runs automatically on Tuesday 10am ET"
    - "Pipeline runs automatically on Thursday 8pm ET"
    - "Pipeline can be triggered manually via GitHub UI"
    - "Generated newsletters are committed to repository"
    - "Workflow fails fast if required secrets are missing"
  artifacts:
    - path: ".github/workflows/newsletter.yml"
      provides: "GitHub Actions workflow configuration"
      min_lines: 50
      contains: "schedule"
  key_links:
    - from: ".github/workflows/newsletter.yml"
      to: "execution/pipeline_runner.py"
      via: "python command"
      pattern: "python execution/pipeline_runner.py"
---

<objective>
Configure GitHub Actions for automated newsletter generation on schedule.

Purpose: Enable hands-free newsletter generation twice per week without manual intervention.
Output: Working GitHub Actions workflow that runs the pipeline on schedule and commits output.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-automation/09-RESEARCH.md
@execution/pipeline_runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow</name>
  <files>.github/workflows/newsletter.yml</files>
  <action>
Create the workflow file with the following specifications:

**Schedule (cron in UTC):**
- Tuesday 10am ET: `0 15 * * 2` (EST approximation)
- Thursday 8pm ET: `0 1 * * 5` (runs Friday 1am UTC in EST)

**Triggers:**
- `schedule` with both cron expressions
- `workflow_dispatch` with optional `topic` input (string, not required)

**Permissions:**
- `contents: write` (for auto-commit)

**Concurrency:**
- Group: `newsletter-pipeline`
- Cancel in progress: false (let runs complete)

**Job configuration:**
- Runner: `ubuntu-latest`
- Timeout: 30 minutes
- Python: 3.12 with pip caching via `actions/setup-python@v5`

**Environment variables (from secrets):**
Map all 8 secrets to environment variables:
- ANTHROPIC_API_KEY
- TUBELAB_API_KEY
- YOUTUBE_API_KEY
- PERPLEXITY_API_KEY
- APIFY_TOKEN
- REDDIT_CLIENT_ID
- REDDIT_CLIENT_SECRET
- REDDIT_USER_AGENT

**Steps:**
1. `actions/checkout@v5`
2. `actions/setup-python@v5` with python-version 3.12 and cache: pip
3. Install dependencies: `pip install -r requirements.txt`
4. Verify required secrets exist (check ANTHROPIC_API_KEY and REDDIT_CLIENT_ID are non-empty, exit 1 if missing)
5. Run pipeline: `python execution/pipeline_runner.py` with optional --topic from workflow_dispatch input
6. Commit and push output: configure git user as github-actions[bot], add output/, commit with message "feat: newsletter $(date +%Y-%m-%d)", push

**Important:**
- Use `${{ secrets.SECRET_NAME }}` syntax for secrets
- Use `${{ github.event.inputs.topic }}` for manual topic input
- Let pipeline exit code propagate naturally (no `continue-on-error`)
- Use `git diff --staged --quiet || git commit` to avoid empty commits
  </action>
  <verify>
Validate workflow syntax:
```bash
# Check YAML syntax
python -c "import yaml; yaml.safe_load(open('.github/workflows/newsletter.yml'))"
echo "YAML syntax valid"

# Verify key elements exist
grep -q "schedule:" .github/workflows/newsletter.yml && echo "Has schedule trigger"
grep -q "workflow_dispatch:" .github/workflows/newsletter.yml && echo "Has manual trigger"
grep -q "ANTHROPIC_API_KEY" .github/workflows/newsletter.yml && echo "Has secrets mapping"
grep -q "pipeline_runner.py" .github/workflows/newsletter.yml && echo "Runs pipeline"
grep -q "git push" .github/workflows/newsletter.yml && echo "Has auto-commit"
```
  </verify>
  <done>
- Workflow file exists at `.github/workflows/newsletter.yml`
- Contains schedule triggers for both Tuesday and Thursday
- Contains workflow_dispatch with topic input
- Maps all 8 secrets to environment variables
- Includes secrets verification step
- Runs pipeline with proper exit code handling
- Auto-commits output to repository
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure GitHub repository secrets</name>
  <action>
User must configure all 8 repository secrets in GitHub.

**Steps:**
1. Go to your repository on GitHub
2. Navigate to Settings -> Secrets and variables -> Actions
3. Click "New repository secret" for each of these 8 secrets:

| Secret Name | Source |
|-------------|--------|
| ANTHROPIC_API_KEY | console.anthropic.com - API Keys |
| TUBELAB_API_KEY | tubelab.net/developers |
| YOUTUBE_API_KEY | console.cloud.google.com - YouTube Data API v3 |
| PERPLEXITY_API_KEY | perplexity.ai/settings/api |
| APIFY_TOKEN | console.apify.com - Settings |
| REDDIT_CLIENT_ID | reddit.com/prefs/apps |
| REDDIT_CLIENT_SECRET | reddit.com/prefs/apps |
| REDDIT_USER_AGENT | Use: `dtc-newsletter/1.0 by /u/your_username` |

**Notes:**
- Copy values from your local `.env` file where available
- For any missing keys, create accounts and generate new API keys
- REDDIT_USER_AGENT is a string, not from a dashboard
  </action>
  <how-to-verify>
After adding secrets:
1. Check Settings -> Secrets shows 8 repository secrets
2. Push the workflow file to main branch
3. Go to Actions tab
4. Click "DTC Newsletter Pipeline" workflow
5. Click "Run workflow" button to trigger manual run
6. Watch the run - it should pass the "Verify required secrets" step
  </how-to-verify>
  <resume-signal>Type "secrets configured" after completing setup and verifying with a manual run</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Workflow syntax:** YAML parses without errors
2. **Schedule configured:** Two cron expressions present
3. **Manual trigger:** workflow_dispatch with topic input
4. **Secrets verification:** Step exists that fails fast on missing secrets
5. **Pipeline execution:** Calls `python execution/pipeline_runner.py`
6. **Auto-commit:** Configures git and pushes output
7. **Secrets in GitHub:** All 8 secrets configured in repository settings
8. **Manual run success:** Workflow completes successfully when triggered manually
</verification>

<success_criteria>
1. `.github/workflows/newsletter.yml` exists and is valid YAML
2. Workflow has schedule triggers for Tuesday 10am ET and Thursday 8pm ET (UTC cron)
3. Workflow has workflow_dispatch trigger with optional topic input
4. All 8 API keys are stored as GitHub Secrets
5. Secrets verification step fails fast if required secrets are missing
6. Pipeline runs and commits output on successful execution
7. Manual workflow run completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-automation/09-01-SUMMARY.md`
</output>
