---
phase: 03-example-workflows
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - directives/weather_lookup.md
  - execution/weather_lookup.py
  - .env.example
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "User can look up weather for any city with a single command"
    - "Missing API key produces helpful setup instructions, not stack trace"
    - "Invalid city name produces clear error message"
    - "Script demonstrates the dotenv + requests pattern for API workflows"
  artifacts:
    - path: "directives/weather_lookup.md"
      provides: "Directive with trigger phrases, API key setup instructions"
      contains: "DOE-VERSION: 2026.01.23"
    - path: "execution/weather_lookup.py"
      provides: "Script that queries OpenWeatherMap API"
      contains: "DOE_VERSION = \"2026.01.23\""
    - path: ".env.example"
      provides: "Example environment variables including WEATHER_API_KEY"
      contains: "WEATHER_API_KEY"
    - path: "requirements.txt"
      provides: "Python dependencies including requests"
      contains: "requests"
  key_links:
    - from: "directives/weather_lookup.md"
      to: "execution/weather_lookup.py"
      via: "version tag sync"
      pattern: "DOE.VERSION.*2026\\.01\\.23"
    - from: "execution/weather_lookup.py"
      to: ".env"
      via: "dotenv load"
      pattern: "load_dotenv.*WEATHER_API_KEY"
---

<objective>
Create a simple API workflow (weather lookup) that demonstrates the dotenv + requests pattern for API key management without requiring complex setup.

Purpose: Teach secure API key handling, environment variable patterns, and graceful error handling when credentials are missing.
Output: Working example that clearly shows the API workflow pattern, even if user doesn't have an API key yet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-example-workflows/03-RESEARCH.md
@directives/_TEMPLATE.md
@execution/_TEMPLATE.py
@.env.example
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create weather lookup directive</name>
  <files>directives/weather_lookup.md</files>
  <action>
Create directive following _TEMPLATE.md structure with clear API key setup instructions:

```markdown
# Weather Lookup
<!-- DOE-VERSION: 2026.01.23 -->

## Goal

Look up current weather for any city using the OpenWeatherMap API. Demonstrates the API key pattern for workflows that require external services.

---

## Trigger Phrases

**Matches:**
- "check weather"
- "weather lookup"
- "what's the weather in [city]"
- "get weather for [city]"

---

## Quick Start

```bash
python execution/weather_lookup.py "San Francisco"
python execution/weather_lookup.py "London"
```

---

## What It Does

1. **Load** — Reads WEATHER_API_KEY from .env file
2. **Request** — Queries OpenWeatherMap API for current conditions
3. **Display** — Shows temperature and weather description

---

## Output

**Deliverable:** Current temperature and weather conditions
**Location:** stdout

---

## Prerequisites

### API Key (Required)

1. Get a free API key at: https://openweathermap.org/api
2. Add to your `.env` file:
   ```
   WEATHER_API_KEY=your_key_here
   ```

Note: Free tier allows 1,000 calls/day — plenty for personal use.

---

## CLI Arguments

| Argument | Default | Description |
|----------|---------|-------------|
| `city` | (required) | City name to look up |

---

## Edge Cases

### City Not Found
**Fix:** API returns 404 — script shows "City not found" error

### Invalid API Key
**Fix:** API returns 401 — script shows "Invalid API key" error

### No API Key Set
**Fix:** Script shows setup instructions before making request

---

## Changelog

### 2026.01.23
- Created
```
  </action>
  <verify>cat directives/weather_lookup.md | grep "DOE-VERSION: 2026.01.23"</verify>
  <done>Directive exists with correct version tag, API key instructions, and all required sections</done>
</task>

<task type="auto">
  <name>Task 2: Create weather lookup script</name>
  <files>execution/weather_lookup.py</files>
  <action>
Create script following _TEMPLATE.py structure with emphasis on API key validation:

```python
#!/usr/bin/env python3
"""
Look up current weather for a city.

Directive: directives/weather_lookup.md

Usage:
    python execution/weather_lookup.py "San Francisco"
    python execution/weather_lookup.py "London"
"""

import os
import sys
import argparse
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# =============================================================================
# VERSION - Must match directive
# =============================================================================
DOE_VERSION = "2026.01.23"

# =============================================================================
# CONFIG
# =============================================================================
API_KEY = os.getenv("WEATHER_API_KEY")
API_URL = "https://api.openweathermap.org/data/2.5/weather"


def main():
    parser = argparse.ArgumentParser(
        description="Get current weather for a city"
    )
    parser.add_argument("city", help="City name (e.g., 'San Francisco')")
    args = parser.parse_args()

    # Validate API key BEFORE making request
    if not API_KEY:
        print("ERROR: WEATHER_API_KEY not set in .env")
        print()
        print("To fix:")
        print("1. Get a free API key at: https://openweathermap.org/api")
        print("2. Add to your .env file:")
        print("   WEATHER_API_KEY=your_key_here")
        return 1

    # Import requests here (after validation) to show pattern
    try:
        import requests
    except ImportError:
        print("ERROR: requests library not installed")
        print("Run: pip install requests")
        return 1

    try:
        # Make API request
        response = requests.get(
            API_URL,
            params={
                "q": args.city,
                "appid": API_KEY,
                "units": "metric"
            },
            timeout=10
        )

        # Handle HTTP errors
        if response.status_code == 401:
            print("ERROR: Invalid API key")
            print("Check your WEATHER_API_KEY in .env")
            return 1

        if response.status_code == 404:
            print(f"ERROR: City not found: {args.city}")
            print("Try a different spelling or add country code (e.g., 'London,UK')")
            return 1

        response.raise_for_status()

        # Parse and display result
        data = response.json()
        city_name = data["name"]
        country = data["sys"]["country"]
        temp = data["main"]["temp"]
        description = data["weather"][0]["description"]

        print(f"Weather in {city_name}, {country}:")
        print(f"  Temperature: {temp}C")
        print(f"  Conditions: {description.title()}")

        return 0

    except requests.exceptions.Timeout:
        print("ERROR: Request timed out")
        print("Check your internet connection and try again")
        return 1
    except requests.exceptions.RequestException as e:
        print(f"ERROR: Request failed: {e}")
        return 1
    except KeyError as e:
        print(f"ERROR: Unexpected API response (missing {e})")
        return 1
    except Exception as e:
        print(f"ERROR: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
```

Key patterns demonstrated:
- dotenv for API key management
- Validate API key at startup (before making request)
- Clear error messages with fix instructions
- Graceful handling of all error cases (401, 404, timeout, etc.)
- Import requests after validation to show the pattern clearly
  </action>
  <verify>python execution/weather_lookup.py --help</verify>
  <done>Script runs and shows help text without errors (even without API key)</done>
</task>

<task type="auto">
  <name>Task 3: Update .env.example and requirements.txt</name>
  <files>.env.example, requirements.txt</files>
  <action>
1. Add WEATHER_API_KEY to .env.example (in the "Workflow-Specific APIs" section):

Find this section in .env.example:
```
# =============================================================================
# Workflow-Specific APIs (add as needed)
# =============================================================================
```

Add after the examples:
```
# Weather lookup example (see directives/weather_lookup.md)
WEATHER_API_KEY=your_openweathermap_key
```

2. Add requests to requirements.txt:

Append to requirements.txt:
```
requests>=2.31.0
```

This keeps the template self-contained — `pip install -r requirements.txt` installs everything needed.
  </action>
  <verify>grep WEATHER_API_KEY .env.example && grep requests requirements.txt</verify>
  <done>.env.example has WEATHER_API_KEY and requirements.txt has requests</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Version sync check:
```bash
grep "DOE-VERSION: 2026.01.23" directives/weather_lookup.md
grep "DOE_VERSION = \"2026.01.23\"" execution/weather_lookup.py
```

2. Help text works (no API key needed):
```bash
python execution/weather_lookup.py --help
```

3. Missing API key shows helpful error:
```bash
# With empty/no .env, should show setup instructions
python execution/weather_lookup.py "London"
```

4. Dependencies updated:
```bash
grep WEATHER_API_KEY .env.example
grep requests requirements.txt
```
</verification>

<success_criteria>
1. `python execution/weather_lookup.py --help` shows usage without errors
2. `python execution/weather_lookup.py "London"` (without API key) shows clear setup instructions
3. Version tags match between directive (DOE-VERSION) and script (DOE_VERSION)
4. `.env.example` includes WEATHER_API_KEY with explanation
5. `requirements.txt` includes requests library
6. Directive clearly explains how to get and configure API key
</success_criteria>

<output>
After completion, create `.planning/phases/03-example-workflows/03-02-SUMMARY.md`
</output>
