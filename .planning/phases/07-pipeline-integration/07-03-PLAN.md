---
phase: 07-pipeline-integration
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - execution/output_manager.py
  - execution/pipeline_runner.py
  - directives/pipeline_runner.md
  - tests/test_output_manager.py
autonomous: true

must_haves:
  truths:
    - "Newsletters saved with auto-incrementing issue numbers"
    - "Newsletters organized in monthly subfolders"
    - "index.json manifest tracks all newsletters"
    - "Desktop notification sent on pipeline completion"
  artifacts:
    - path: "execution/output_manager.py"
      provides: "Newsletter output organization and notifications"
      exports: ["save_newsletter", "get_next_issue_number", "notify"]
    - path: "directives/pipeline_runner.md"
      provides: "DOE directive for pipeline"
      contains: "DOE-VERSION: 2026.01.31"
    - path: "tests/test_output_manager.py"
      provides: "Output manager tests"
      min_lines: 60
  key_links:
    - from: "execution/output_manager.py"
      to: "output/newsletters/index.json"
      via: "JSON file read/write"
      pattern: "index\\.json"
    - from: "execution/pipeline_runner.py"
      to: "execution/output_manager.py"
      via: "import save_newsletter"
      pattern: "output_manager"
---

<objective>
Create output organization module for newsletters (auto-increment, monthly folders, manifest) and macOS notifications. Update pipeline_runner to use output_manager. Create DOE directive.

Purpose: Complete the pipeline integration with proper output organization and user notification. Crystallize as DOE workflow.

Output: Working output_manager.py, updated pipeline_runner.py, DOE directive, and tests.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-pipeline-integration/07-CONTEXT.md
@.planning/phases/07-pipeline-integration/07-RESEARCH.md

# Pipeline runner to update (from Plan 02)
@execution/pipeline_runner.py

# Existing DOE directive pattern
@directives/newsletter_generate.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create output_manager.py module</name>
  <files>execution/output_manager.py</files>
  <action>
Create output organization module with:

1. **Constants**:
   ```python
   NEWSLETTERS_DIR = Path("output/newsletters")
   INDEX_PATH = NEWSLETTERS_DIR / "index.json"
   ```

2. **slugify(text: str) -> str** - Convert topic to URL-safe slug:
   - Lowercase
   - Replace non-alphanumeric with hyphens: `re.sub(r'[^a-z0-9]+', '-', text.lower())`
   - Strip leading/trailing hyphens
   - Default to "newsletter" if empty

3. **get_next_issue_number() -> int** - Scan for highest existing issue:
   - Glob all .md files in NEWSLETTERS_DIR (including subfolders)
   - Match pattern `(\d{3})-` for issue number
   - Return max + 1, or 1 if no files

4. **get_monthly_folder() -> Path** - Get/create current month's folder:
   - Format: YYYY-MM (e.g., "2026-01")
   - Create if doesn't exist
   - Return path

5. **save_newsletter(output: NewsletterOutput, topic: str = None) -> Path**:
   - Get next issue number
   - Get monthly folder
   - Generate slug from topic or output metadata
   - Filename: `{issue:03d}-{slug}.md`
   - Write markdown content
   - Update index.json
   - Return full path

6. **update_index(entry: dict)** - Update index.json:
   - Load existing or create: `{"newsletters": []}`
   - Append entry with fields:
     - issue: int
     - topic: str
     - date: ISO date string
     - path: relative path from newsletters dir
     - subject_line: str
     - cost: float (optional)
   - Write with indent=2

7. **notify(title: str, message: str)** - macOS desktop notification:
   - Use osascript via subprocess:
     ```python
     script = f'display notification "{message}" with title "{title}"'
     subprocess.run(["osascript", "-e", script], capture_output=True)
     ```
   - Wrap in try/except - log failure but don't raise
   - Silent no-op if not macOS (check sys.platform)

8. **notify_pipeline_complete(result: PipelineResult)** - Send completion notification:
   - Success: "DTC Newsletter Complete" + issue number and cost
   - Failure: "DTC Newsletter Failed" + error summary

Add DOE-VERSION: 2026.01.31 in docstring.
  </action>
  <verify>
python -c "from execution.output_manager import save_newsletter, get_next_issue_number, notify, slugify; print('Imports OK')"
  </verify>
  <done>
Module imports without error, all functions defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline_runner.py to use output_manager</name>
  <files>execution/pipeline_runner.py</files>
  <action>
Update pipeline_runner.py to integrate output_manager:

1. Add import:
   ```python
   from execution.output_manager import save_newsletter, notify_pipeline_complete
   ```

2. Update run_pipeline() to save newsletter after generation:
   ```python
   # After successful newsletter generation
   if newsletter_output:
       try:
           path = save_newsletter(newsletter_output, topic=topic)
           announce(f"Newsletter saved: {path}", quiet)
       except Exception as e:
           warnings.append(f"Failed to save newsletter: {e}")
   ```

3. Add notification at end of run_pipeline():
   ```python
   # At end, before return
   result = PipelineResult(...)
   notify_pipeline_complete(result)
   return result
   ```

4. Update PipelineResult to include newsletter_path:
   - Set from save_newsletter() return value

5. Update CLI main() to print newsletter path in summary:
   ```python
   if result.newsletter_path:
       print(f"\nNewsletter: {result.newsletter_path}")
   ```

Ensure save_newsletter failure doesn't fail the pipeline (graceful degradation).
  </action>
  <verify>
python execution/pipeline_runner.py --help
python -c "from execution.pipeline_runner import run_pipeline; print('Updated OK')"
  </verify>
  <done>
pipeline_runner.py updated with output_manager integration. CLI still works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DOE directive and tests</name>
  <files>
directives/pipeline_runner.md
tests/test_output_manager.py
  </files>
  <action>
**Create directives/pipeline_runner.md:**

DOE directive following existing pattern from newsletter_generate.md:

```markdown
# Pipeline Runner
<!-- DOE-VERSION: 2026.01.31 -->

## Goal
Run the complete DTC newsletter pipeline with a single command.

## Trigger Phrases
**Matches:**
- "run the pipeline"
- "generate newsletter"
- "run newsletter pipeline"
- "create this week's newsletter"

## Quick Start
```bash
# Full pipeline (auto-detect topic)
python execution/pipeline_runner.py

# Specify topic
python execution/pipeline_runner.py --topic "tiktok shop strategies"

# Quiet mode (for automation)
python execution/pipeline_runner.py -q

# Skip affiliate discovery
python execution/pipeline_runner.py --skip-affiliates
```

## What It Does
1. Aggregates content from Reddit, YouTube, and stretch sources
2. Generates 5-section newsletter with Hormozi/Suby voice
3. Discovers affiliate opportunities (optional)
4. Saves newsletter to output/newsletters/{month}/{issue}-{topic}.md
5. Updates index.json manifest
6. Logs costs to data/cost_log.json
7. Sends macOS notification on completion

## Output
- Newsletter markdown: `output/newsletters/YYYY-MM/{issue}-{topic}.md`
- Index manifest: `output/newsletters/index.json`
- Cost log: `data/cost_log.json`

## Flags
| Flag | Description |
|------|-------------|
| `-q, --quiet` | Suppress progress output |
| `-v, --verbose` | Show debug output |
| `--topic TEXT` | Override auto-detected topic |
| `--skip-affiliates` | Skip affiliate discovery |
| `--dry-run` | Show what would run |

## Error Handling
- Pipeline continues if individual sources fail
- Claude API retries 3x with exponential backoff
- Warns (doesn't fail) if cost > $1/operation or $10/run
- Notification sent on both success and failure
```

**Create tests/test_output_manager.py:**

1. **test_slugify_basic** - "TikTok Shop Strategies" -> "tiktok-shop-strategies"

2. **test_slugify_special_chars** - "What's Working: 2026!" -> "what-s-working-2026"

3. **test_slugify_empty** - Empty string -> "newsletter"

4. **test_get_next_issue_number_empty** - No files -> 1

5. **test_get_next_issue_number_existing** - Files exist -> max + 1
   - Use tmp_path to create test files

6. **test_get_monthly_folder** - Creates YYYY-MM folder

7. **test_save_newsletter** - Full save workflow
   - Verify file created with correct name
   - Verify index.json updated

8. **test_update_index_new** - Creates index.json if not exists

9. **test_update_index_append** - Appends to existing index

10. **test_notify_macos** - Mock subprocess.run, verify called with osascript
    - Use monkeypatch for sys.platform

11. **test_notify_non_macos** - Verify no-op on non-macOS
    - Monkeypatch sys.platform to "linux"

12. **test_notify_pipeline_complete_success** - Verify correct title/message

13. **test_notify_pipeline_complete_failure** - Verify failure message
  </action>
  <verify>
cat directives/pipeline_runner.md | head -5
pytest tests/test_output_manager.py -v
  </verify>
  <done>
DOE directive exists with version 2026.01.31. All output_manager tests pass (13+ tests).
  </done>
</task>

</tasks>

<verification>
1. `python execution/pipeline_runner.py --help` - Shows all flags
2. `pytest tests/test_output_manager.py -v` - All tests pass
3. `cat output/newsletters/index.json` - Manifest structure valid (after test run)
4. `grep DOE-VERSION directives/pipeline_runner.md` - Shows 2026.01.31
</verification>

<success_criteria>
- output_manager.py exists with save_newsletter, notify functions
- Issue numbers auto-increment correctly
- Monthly subfolders created automatically
- index.json manifest updated on each save
- macOS notifications sent (silently fails on non-macOS)
- DOE directive created with version 2026.01.31
- All tests pass (13+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/07-pipeline-integration/07-03-SUMMARY.md`
</output>
