---
phase: 08-manual-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - execution/batch_runner.py
  - tests/test_batch_runner.py
autonomous: true

must_haves:
  truths:
    - "Batch runner discovers 8+ topics with outlier scores >= 3.0"
    - "Topics are diverse across e-com categories (no category appears >2 times)"
    - "Pre-flight check validates required API keys before batch starts"
    - "Cost budget enforced ($40 max) with stop-on-exceed"
  artifacts:
    - path: "execution/batch_runner.py"
      provides: "Batch orchestration with diversity filter, pre-flight checks, cost control"
      min_lines: 200
      exports: ["BatchRunner", "select_diverse_topics", "check_api_keys"]
    - path: "tests/test_batch_runner.py"
      provides: "Tests for batch runner including diversity filter"
      min_lines: 100
  key_links:
    - from: "execution/batch_runner.py"
      to: "execution/content_aggregate.py"
      via: "topic discovery import"
      pattern: "from execution.content_aggregate"
    - from: "execution/batch_runner.py"
      to: "execution/cost_tracker.py"
      via: "cost budget enforcement"
      pattern: "from execution.cost_tracker"
---

<objective>
Create the batch orchestrator for Phase 8 execution.

Purpose: Enable batch generation of 8 newsletters and 8 products with diversity filtering, pre-flight API checks, and cost budget enforcement. This is the control layer for the entire manual execution phase.

Output: `execution/batch_runner.py` with BatchRunner class, diversity filter, and pre-flight checks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-manual-execution/08-CONTEXT.md
@.planning/phases/08-manual-execution/08-RESEARCH.md

# Existing modules to wrap (not modify)
@execution/content_aggregate.py
@execution/pipeline_runner.py
@execution/product_factory.py
@execution/cost_tracker.py
@execution/anti_pattern_validator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch_runner.py with diversity filter and pre-flight checks</name>
  <files>execution/batch_runner.py</files>
  <action>
Create `execution/batch_runner.py` with:

1. **E-com category definitions** (from RESEARCH.md):
```python
E_COM_CATEGORIES = [
    "shipping_logistics",
    "pricing_margins", 
    "conversion_optimization",
    "ads_marketing",
    "inventory_management",
    "customer_retention",
    "product_sourcing",
    "platform_tools",
]
```

2. **Topic categorization function**:
```python
def categorize_ecom_topic(topic: str) -> str:
    """Classify topic into e-com category using keyword matching."""
    # Keywords for each category
    CATEGORY_KEYWORDS = {
        "shipping_logistics": ["ship", "fulfillment", "delivery", "freight", "3pl"],
        "pricing_margins": ["price", "margin", "profit", "discount", "cost"],
        "conversion_optimization": ["conversion", "checkout", "cart", "abandon"],
        "ads_marketing": ["ad", "facebook", "tiktok", "marketing", "creative"],
        "inventory_management": ["inventory", "stock", "sku", "warehouse"],
        "customer_retention": ["retention", "churn", "loyalty", "email", "sms"],
        "product_sourcing": ["supplier", "sourcing", "alibaba", "manufacturer"],
        "platform_tools": ["shopify", "app", "plugin", "integration", "tool"],
    }
    topic_lower = topic.lower()
    for category, keywords in CATEGORY_KEYWORDS.items():
        if any(kw in topic_lower for kw in keywords):
            return category
    return "platform_tools"  # Default
```

3. **Diversity filter** (from RESEARCH.md):
```python
def select_diverse_topics(content: list[dict], count: int = 8) -> list[dict]:
    """
    Select top topics ensuring diversity across e-com sub-areas.
    
    1. Sort by outlier_score descending
    2. Categorize each by e-com sub-area
    3. Select highest from each category first
    4. Fill remaining with next highest overall
    """
```

4. **Pre-flight API check**:
```python
def check_api_keys() -> dict:
    """
    Check required and optional API keys.
    Returns dict with 'ready', 'missing_required', 'missing_optional'.
    """
    required = {
        "ANTHROPIC_API_KEY": os.getenv("ANTHROPIC_API_KEY"),
    }
    optional = {
        "REDDIT_CLIENT_ID": os.getenv("REDDIT_CLIENT_ID"),
        "PERPLEXITY_API_KEY": os.getenv("PERPLEXITY_API_KEY"),
        "TUBELAB_API_KEY": os.getenv("TUBELAB_API_KEY"),
        "APIFY_TOKEN": os.getenv("APIFY_TOKEN"),
    }
    # Return status dict
```

5. **BatchRunner class**:
```python
class BatchRunner:
    MAX_BUDGET = 40.0
    
    def __init__(self, dry_run: bool = False):
        self.tracker = CostTracker()
        self.dry_run = dry_run
        self.results = {"newsletters": [], "products": []}
    
    def discover_topics(self, min_score: float = 3.0, count: int = 8) -> list[dict]:
        """Use content_aggregate to find topics, then apply diversity filter."""
        
    def can_continue(self) -> bool:
        """Check if cost budget allows continuing."""
        
    def run_preflight(self) -> bool:
        """Run pre-flight checks, return True if ready."""
```

6. **CLI interface**:
```python
if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--dry-run", action="store_true")
    parser.add_argument("--discover-only", action="store_true")
    parser.add_argument("--min-score", type=float, default=3.0)
```

Do NOT import from pipeline_runner or product_factory yet - those will be integrated in Plans 02/03.
  </action>
  <verify>
```bash
python -c "from execution.batch_runner import BatchRunner, select_diverse_topics, check_api_keys; print('Imports OK')"
```
  </verify>
  <done>BatchRunner class exists with discover_topics(), can_continue(), run_preflight() methods. Diversity filter correctly selects topics ensuring category spread.</done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive tests for batch_runner</name>
  <files>tests/test_batch_runner.py</files>
  <action>
Create `tests/test_batch_runner.py` with:

1. **Test categorize_ecom_topic**:
   - "shipping costs" -> "shipping_logistics"
   - "facebook ads" -> "ads_marketing"
   - "shopify app" -> "platform_tools"
   - Unknown topic -> defaults to "platform_tools"

2. **Test select_diverse_topics**:
   - Given 10 topics with different categories, selects 8 unique categories
   - Given 4 topics with same category, still returns all 4 (allows repeats after first pass)
   - Given 12 topics, 8 categories, returns exactly 8 with max diversity
   - Sorts by outlier_score when multiple in same category

3. **Test check_api_keys**:
   - With ANTHROPIC_API_KEY set: ready=True
   - Without ANTHROPIC_API_KEY: ready=False, missing_required=['ANTHROPIC_API_KEY']
   - With optional keys missing: warning list populated

4. **Test BatchRunner.can_continue**:
   - At $0: returns True
   - At $39: returns True
   - At $41: returns False
   - At exactly $40: returns True (boundary)

5. **Test BatchRunner.run_preflight**:
   - Returns False if required keys missing
   - Returns True with warnings if optional keys missing

6. **Test BatchRunner.discover_topics** (mocked):
   - Mock content_aggregate output
   - Verify diversity filter applied
   - Verify min_score filtering
  </action>
  <verify>
```bash
pytest tests/test_batch_runner.py -v
```
  </verify>
  <done>All tests pass. Diversity filter, pre-flight checks, and cost control validated.</done>
</task>

<task type="auto">
  <name>Task 3: Verify batch_runner CLI works end-to-end</name>
  <files>execution/batch_runner.py</files>
  <action>
Add CLI commands and verify:

1. `--discover-only` mode:
```bash
python execution/batch_runner.py --discover-only --dry-run
```
Should output discovered topics with categories (no API calls in dry-run).

2. `--check-keys` mode:
```bash
python execution/batch_runner.py --check-keys
```
Should output API key status.

3. Add `--check-keys` argument to CLI if not present.

4. Ensure dry-run mode:
   - Does NOT call any external APIs
   - Uses mock/cached data if available
   - Reports what WOULD happen
  </action>
  <verify>
```bash
python execution/batch_runner.py --check-keys
python execution/batch_runner.py --discover-only --dry-run 2>&1 | head -20
```
  </verify>
  <done>CLI works with --check-keys showing API status and --discover-only --dry-run showing mock topic discovery.</done>
</task>

</tasks>

<verification>
1. `python -c "from execution.batch_runner import BatchRunner"` succeeds
2. `pytest tests/test_batch_runner.py -v` all pass
3. `python execution/batch_runner.py --check-keys` shows API status
4. Diversity filter logic verified in tests
</verification>

<success_criteria>
- BatchRunner class exists with discover_topics, can_continue, run_preflight methods
- select_diverse_topics ensures category diversity (at least 6 unique categories in 8 topics when possible)
- check_api_keys validates required (ANTHROPIC) and optional (Reddit, Perplexity, TubeLab, Apify) keys
- Cost budget enforced at $40 max
- All tests passing
- CLI interface working for pre-flight checks and topic discovery
</success_criteria>

<output>
After completion, create `.planning/phases/08-manual-execution/08-01-SUMMARY.md`
</output>
