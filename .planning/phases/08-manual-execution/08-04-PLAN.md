---
phase: 08-manual-execution
plan: 04
type: execute
wave: 3
depends_on: [08-02, 08-03]
files_modified:
  - output/content_calendar.json
  - output/content_calendar.md
  - execution/batch_runner.py
autonomous: true

must_haves:
  truths:
    - "Content calendar exists in JSON and Markdown formats"
    - "Calendar lists all 8 newsletters with week, topic, path"
    - "Calendar lists all 8 products with week, pain point, type, path"
    - "Stats section shows total counts and cost"
    - "DOE directive created for batch_runner"
  artifacts:
    - path: "output/content_calendar.json"
      provides: "Machine-readable content calendar"
      contains: '"newsletters"'
    - path: "output/content_calendar.md"
      provides: "Human-readable content calendar table"
      contains: "## Newsletters"
    - path: "directives/batch_runner.md"
      provides: "DOE directive for batch execution"
      contains: "DOE-VERSION"
  key_links:
    - from: "output/content_calendar.json"
      to: "output/newsletters/"
      via: "path references"
      pattern: "output/newsletters"
    - from: "output/content_calendar.json"
      to: "output/products/"
      via: "path references"
      pattern: "output/products"
---

<objective>
Generate content calendar and crystallize batch runner as DOE directive.

Purpose: Create the 8-week content calendar (JSON + Markdown) that tracks all generated newsletters and products. Crystallize the batch runner workflow as a reusable DOE pattern for future batch executions.

Output: `output/content_calendar.json`, `output/content_calendar.md`, `directives/batch_runner.md`
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-manual-execution/08-CONTEXT.md
@.planning/phases/08-manual-execution/08-02-SUMMARY.md
@.planning/phases/08-manual-execution/08-03-SUMMARY.md

# Core module
@execution/batch_runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content calendar generation to BatchRunner</name>
  <files>execution/batch_runner.py</files>
  <action>
Add content calendar generation to BatchRunner:

```python
import json
from datetime import datetime
from pathlib import Path

class BatchRunner:
    # ... existing code ...
    
    def generate_content_calendar(self, output_dir: Path = None) -> tuple[Path, Path]:
        """
        Generate content calendar in JSON + Markdown formats.
        
        Uses self.results["newsletters"] and self.results["products"] populated
        by generate_newsletters() and generate_products().
        """
        if output_dir is None:
            output_dir = Path("output")
        
        output_dir.mkdir(parents=True, exist_ok=True)
        
        newsletters = self.results.get("newsletters", [])
        products = self.results.get("products", [])
        
        # Calculate stats
        successful_newsletters = sum(1 for n in newsletters if n.get("status") == "success")
        successful_products = sum(1 for p in products if p.get("status") == "success")
        total_cost = (
            sum(n.get("cost", 0) for n in newsletters) +
            sum(p.get("cost", 0) for p in products)
        )
        
        calendar = {
            "generated_at": datetime.now().isoformat(),
            "newsletters": newsletters,
            "products": products,
            "stats": {
                "newsletters_generated": successful_newsletters,
                "newsletters_total": len(newsletters),
                "products_generated": successful_products,
                "products_total": len(products),
                "total_cost": round(total_cost, 2),
                "failures_recovered": sum(1 for n in newsletters if n.get("status") == "validation_failed") +
                                      sum(1 for p in products if "fallback" in str(p.get("type", ""))),
            }
        }
        
        # Write JSON
        json_path = output_dir / "content_calendar.json"
        json_path.write_text(json.dumps(calendar, indent=2))
        
        # Write Markdown
        md_lines = [
            "# Content Calendar",
            "",
            f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M')}",
            f"**Total Cost:** ${total_cost:.2f}",
            "",
            "## Newsletters",
            "",
            "| Week | Topic | Path | Status |",
            "|------|-------|------|--------|",
        ]
        
        for n in newsletters:
            topic = n.get("topic", "N/A")[:40]
            path = n.get("path", "N/A")
            status = n.get("status", "pending")
            status_icon = "OK" if status == "success" else status.upper()
            md_lines.append(f"| {n.get('week', '?')} | {topic} | `{path}` | {status_icon} |")
        
        md_lines.extend([
            "",
            "## Products",
            "",
            "| Week | Pain Point | Type | Path | Status |",
            "|------|------------|------|------|--------|",
        ])
        
        for p in products:
            pain_point = p.get("pain_point", "N/A")[:30]
            ptype = p.get("type", "N/A")
            path = p.get("path", "N/A")
            status = p.get("status", "pending")
            status_icon = "OK" if status == "success" else status.upper()
            md_lines.append(f"| {p.get('week', '?')} | {pain_point} | {ptype} | `{path}` | {status_icon} |")
        
        md_lines.extend([
            "",
            "## Stats",
            "",
            f"- Newsletters: {successful_newsletters}/{len(newsletters)} successful",
            f"- Products: {successful_products}/{len(products)} successful",
            f"- Total Cost: ${total_cost:.2f}",
            "",
            "---",
            "*Generated by batch_runner.py*",
        ])
        
        md_path = output_dir / "content_calendar.md"
        md_path.write_text("\n".join(md_lines))
        
        return json_path, md_path
```

Add CLI command:
```python
parser.add_argument("--generate-calendar", action="store_true",
                   help="Generate content calendar from results")
```

Also add `--status` command to show current batch status:
```python
parser.add_argument("--status", action="store_true",
                   help="Show current batch status")
```
  </action>
  <verify>
```bash
python -c "from execution.batch_runner import BatchRunner; br = BatchRunner(); print('Calendar generation ready')"
```
  </verify>
  <done>BatchRunner.generate_content_calendar() method exists and produces JSON + Markdown.</done>
</task>

<task type="auto">
  <name>Task 2: Generate content calendar from completed batch</name>
  <files>output/content_calendar.json, output/content_calendar.md</files>
  <action>
Generate the content calendar:

1. **Check batch results exist**:
```bash
python execution/batch_runner.py --status
```
Should show newsletters and products generated in Plans 02/03.

2. **Generate calendar**:
```bash
python execution/batch_runner.py --generate-calendar
```

3. **Verify JSON output**:
```bash
cat output/content_calendar.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'Newsletters: {d[\"stats\"][\"newsletters_generated\"]}'); print(f'Products: {d[\"stats\"][\"products_generated\"]}')"
```

4. **Verify Markdown output**:
```bash
head -30 output/content_calendar.md
```
Should show formatted tables with week, topic, path, status.
  </action>
  <verify>
```bash
test -f output/content_calendar.json && test -f output/content_calendar.md && echo "Calendar files exist"
cat output/content_calendar.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'Stats: {d[\"stats\"]}')"
```
  </verify>
  <done>content_calendar.json and content_calendar.md exist with 8 newsletters and 8 products listed.</done>
</task>

<task type="auto">
  <name>Task 3: Create DOE directive for batch_runner</name>
  <files>directives/batch_runner.md</files>
  <action>
Create `directives/batch_runner.md`:

```markdown
# Batch Runner
<!-- DOE-VERSION: 2026.01.31 -->

## Goal
Generate batches of newsletters and products with diversity filtering, cost control, and quality validation.

## Trigger Phrases
- "run batch generation"
- "generate 8 newsletters"
- "generate 8 products"
- "batch execute"
- "generate content buffer"

## Quick Start

```bash
# Pre-flight check
python execution/batch_runner.py --check-keys

# Discover topics (8 diverse e-com topics)
python execution/batch_runner.py --discover-only

# Generate newsletters (8)
python execution/batch_runner.py --generate-newsletters

# Generate products (8)  
python execution/batch_runner.py --generate-products

# Generate content calendar
python execution/batch_runner.py --generate-calendar

# Full batch (all steps)
python execution/batch_runner.py --full-batch
```

## What It Does

1. **Pre-flight Check**: Validates required API keys (ANTHROPIC_API_KEY) and warns about optional keys
2. **Topic Discovery**: Uses content_aggregate.py to find trending topics, applies diversity filter
3. **Newsletter Generation**: Runs pipeline_runner for each topic, validates output, tracks costs
4. **Product Generation**: Uses product_factory for each pain point, applies type distribution (4-5 hard, 3 easy)
5. **Content Calendar**: Generates JSON + Markdown tracking all output

## Key Features

- **Diversity Filter**: Ensures topics span different e-com categories (shipping, pricing, ads, etc.)
- **Cost Control**: Stops batch if cumulative cost exceeds $40
- **Quality Validation**: Anti-pattern checks, structural validation, concrete number requirements
- **Fallback Types**: If HTML tool fails, automatically tries automation, etc.
- **Graceful Degradation**: Continues batch even if some items fail

## Output

- Newsletters in `output/newsletters/YYYY-MM/NNN-topic.md`
- Products in `output/products/product-name/`
- Calendar in `output/content_calendar.json` and `output/content_calendar.md`

## Cost Estimate

- 8 newsletters: ~$8-12 (Claude API calls)
- 8 products: ~$8-15 (Claude API calls + generation)
- Total: ~$16-27 typical, $40 max budget
```
  </action>
  <verify>
```bash
cat directives/batch_runner.md | head -5
grep "DOE-VERSION" directives/batch_runner.md
```
  </verify>
  <done>DOE directive exists with version 2026.01.31, trigger phrases, and usage documentation.</done>
</task>

</tasks>

<verification>
1. `cat output/content_calendar.json` shows 8 newsletters and 8 products
2. `cat output/content_calendar.md` shows formatted tables
3. `cat directives/batch_runner.md` shows DOE directive with version tag
4. Stats section shows total cost and success counts
</verification>

<success_criteria>
- content_calendar.json exists with newsletters[], products[], stats{}
- content_calendar.md exists with formatted tables
- Calendar shows 8 newsletters and 8 products (with status for each)
- DOE directive batch_runner.md exists with version 2026.01.31
- Phase 8 complete: 8 newsletters + 8 products + content calendar
</success_criteria>

<output>
After completion, create `.planning/phases/08-manual-execution/08-04-SUMMARY.md`
</output>
