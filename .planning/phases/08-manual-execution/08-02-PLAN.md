---
phase: 08-manual-execution
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - execution/batch_runner.py
  - output/newsletters/
autonomous: false

must_haves:
  truths:
    - "8 newsletters generated, each in output/newsletters/"
    - "Each newsletter passes anti-pattern validation"
    - "Each newsletter has 5 sections"
    - "Each newsletter has at least 2 concrete numbers ($ or %)"
    - "No duplicate topics (all 8 are distinct)"
  artifacts:
    - path: "output/newsletters/*/*.md"
      provides: "8 newsletter markdown files ready for Beehiiv"
      count: 8
    - path: "output/newsletters/index.json"
      provides: "Newsletter manifest with metadata"
      contains: '"newsletters"'
  key_links:
    - from: "execution/batch_runner.py"
      to: "execution/pipeline_runner.py"
      via: "newsletter generation wrapper"
      pattern: "from execution.pipeline_runner import run_pipeline"
---

<objective>
Generate 8 newsletters from diverse topics using the batch runner.

Purpose: Validate the newsletter pipeline works end-to-end by generating a full 8-week content buffer. Each newsletter must pass quality validation (anti-patterns, structure, concrete numbers).

Output: 8 newsletter markdown files in `output/newsletters/` organized by month, with index.json manifest.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-manual-execution/08-CONTEXT.md
@.planning/phases/08-manual-execution/08-RESEARCH.md
@.planning/phases/08-manual-execution/08-01-SUMMARY.md

# Core modules
@execution/batch_runner.py
@execution/pipeline_runner.py
@execution/anti_pattern_validator.py
@execution/output_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add newsletter generation to BatchRunner</name>
  <files>execution/batch_runner.py</files>
  <action>
Add newsletter generation method to BatchRunner:

```python
from execution.pipeline_runner import run_pipeline
from execution.anti_pattern_validator import validate_voice
from pathlib import Path

def validate_newsletter(path: Path) -> dict:
    """
    Full quality validation per CONTEXT.md:
    1. Anti-pattern check (no forbidden phrases)
    2. Structural check (5 sections present)
    3. Quality gate (at least 2 concrete numbers)
    """
    content = path.read_text()
    
    # 1. Anti-pattern check
    is_valid, violations = validate_voice(content)
    if not is_valid:
        return {"is_valid": False, "violations": violations, "stage": "anti_pattern"}
    
    # 2. Structural check - look for section headers or separators
    sections = [s for s in content.split("\n\n") if s.strip()]
    if len(sections) < 5:
        return {"is_valid": False, "violations": [f"Only {len(sections)} sections found"], "stage": "structure"}
    
    # 3. Quality gate - concrete numbers
    has_numbers = sum([
        "$" in content,
        "%" in content,
        any(char.isdigit() for char in content),
    ])
    if has_numbers < 2:
        return {"is_valid": False, "violations": ["Fewer than 2 number indicators"], "stage": "quality"}
    
    return {"is_valid": True, "violations": [], "stage": "passed"}

class BatchRunner:
    # ... existing code ...
    
    def generate_newsletters(self, topics: list[dict]) -> list[dict]:
        """
        Generate 8 newsletters from topics.
        
        For each topic:
        1. Run pipeline_runner with --topic
        2. Validate output
        3. If fails: log and continue (don't block batch)
        4. Track cost and check budget
        """
        results = []
        
        for i, topic_data in enumerate(topics, 1):
            topic = topic_data.get("title") or topic_data.get("topic", "Unknown")
            print(f"\n[{i}/{len(topics)}] Generating newsletter: {topic[:50]}...")
            
            if not self.can_continue():
                print(f"  STOP: Budget exceeded (${self.tracker.get_total():.2f})")
                break
            
            if self.dry_run:
                results.append({
                    "week": i,
                    "topic": topic,
                    "path": f"output/newsletters/mock-{i}.md",
                    "status": "dry_run",
                    "cost": 0,
                })
                continue
            
            try:
                result = run_pipeline(topic=topic, quiet=True, skip_affiliates=True)
                
                if result.success and result.newsletter_path:
                    validation = validate_newsletter(result.newsletter_path)
                    if validation["is_valid"]:
                        results.append({
                            "week": i,
                            "topic": topic,
                            "path": str(result.newsletter_path),
                            "status": "success",
                            "cost": result.total_cost,
                        })
                    else:
                        results.append({
                            "week": i,
                            "topic": topic,
                            "path": str(result.newsletter_path),
                            "status": "validation_failed",
                            "violations": validation["violations"],
                            "cost": result.total_cost,
                        })
                else:
                    results.append({
                        "week": i,
                        "topic": topic,
                        "status": "failed",
                        "errors": result.errors,
                        "cost": result.total_cost,
                    })
                    
                # Update cost tracker
                self.tracker.add_cost("newsletter", result.total_cost)
                
            except Exception as e:
                results.append({
                    "week": i,
                    "topic": topic,
                    "status": "error",
                    "error": str(e),
                    "cost": 0,
                })
        
        self.results["newsletters"] = results
        return results
```

Add CLI command:
```python
parser.add_argument("--generate-newsletters", action="store_true")
```
  </action>
  <verify>
```bash
python -c "from execution.batch_runner import BatchRunner; br = BatchRunner(dry_run=True); print('Newsletter generation ready')"
```
  </verify>
  <done>BatchRunner.generate_newsletters() method exists and wraps pipeline_runner with validation.</done>
</task>

<task type="auto">
  <name>Task 2: Run newsletter generation batch</name>
  <files>output/newsletters/</files>
  <action>
Execute the newsletter generation:

1. **Pre-flight check**:
```bash
python execution/batch_runner.py --check-keys
```
Verify ANTHROPIC_API_KEY is set.

2. **Discover topics** (if not already done):
```bash
python execution/batch_runner.py --discover-only
```
Save topics to `.tmp/topics.json`.

3. **Generate newsletters**:
```bash
python execution/batch_runner.py --generate-newsletters
```

**Expected flow:**
- Discovers 8 diverse topics
- Generates each newsletter via pipeline_runner
- Validates each output
- Tracks costs
- Stops if budget exceeded

4. **Monitor output**:
- Watch for "Generating newsletter X/8" progress
- Check `output/newsletters/index.json` updates
- Note any validation failures

5. **Handle failures**:
- If anti-pattern validation fails: note for human review
- If structural validation fails: note for human review
- Do NOT retry automatically in this plan (human review handles edge cases per CONTEXT.md)
  </action>
  <verify>
```bash
ls output/newsletters/*/
cat output/newsletters/index.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'Newsletters: {len(d.get(\"newsletters\", []))}')"
```
  </verify>
  <done>8 newsletter files exist in output/newsletters/. Index.json shows 8 entries. Most pass validation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>8 newsletters generated using the pipeline</what-built>
  <how-to-verify>
1. Check the count:
   ```bash
   ls output/newsletters/*/*.md | wc -l
   ```
   Should show 8 files.

2. Open 2-3 newsletters in your editor and verify:
   - Has 5 distinct sections (Instant Reward, What's Working Now, The Breakdown, Tool of the Week, PS)
   - Contains concrete numbers ($ amounts, percentages)
   - Voice feels like Hormozi/Suby hybrid (punchy, specific, no fluff)
   - No forbidden phrases (basically, just wanted to, etc.)

3. Check validation results:
   ```bash
   python execution/batch_runner.py --status
   ```
   (Or check .tmp/batch_status.json)

4. Note any newsletters needing regeneration for later.
  </how-to-verify>
  <resume-signal>Type "approved" if newsletters look good, or describe which ones need regeneration</resume-signal>
</task>

</tasks>

<verification>
1. `ls output/newsletters/*/*.md | wc -l` shows 8
2. `cat output/newsletters/index.json` shows 8 newsletter entries
3. Human verified 2-3 newsletters match voice and structure requirements
</verification>

<success_criteria>
- 8 newsletter markdown files exist in output/newsletters/
- Each newsletter has 5 sections (verified by human spot-check)
- Each newsletter contains concrete numbers
- Total cost tracked and under $40 budget
- Index.json manifest updated
- Human has approved the batch quality
</success_criteria>

<output>
After completion, create `.planning/phases/08-manual-execution/08-02-SUMMARY.md`
</output>
