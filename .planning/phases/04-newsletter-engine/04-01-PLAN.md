---
phase: 04-newsletter-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - execution/voice_profile.py
  - execution/claude_client.py
  - execution/anti_pattern_validator.py
  - tests/test_voice_profile.py
  - tests/test_claude_client.py
  - tests/test_anti_pattern_validator.py
autonomous: true

must_haves:
  truths:
    - "Voice profile contains complete Hormozi/Suby guidelines"
    - "Anti-patterns list covers all 20+ forbidden phrases"
    - "Claude client uses prompt caching for voice profile"
    - "Validator catches any anti-pattern in generated text"
  artifacts:
    - path: "execution/voice_profile.py"
      provides: "Voice profile constants and anti-patterns list"
      contains: "VOICE_PROFILE_PROMPT"
    - path: "execution/claude_client.py"
      provides: "Anthropic API wrapper with prompt caching"
      exports: ["generate_with_voice"]
    - path: "execution/anti_pattern_validator.py"
      provides: "Post-processing validation"
      exports: ["validate_voice", "ANTI_PATTERNS"]
  key_links:
    - from: "execution/claude_client.py"
      to: "execution/voice_profile.py"
      via: "imports VOICE_PROFILE_PROMPT"
      pattern: "from.*voice_profile.*import"
    - from: "execution/claude_client.py"
      to: "anthropic"
      via: "SDK client with cache_control"
      pattern: "cache_control.*ephemeral"
---

<objective>
Create the foundation for newsletter generation: voice profile data, Claude client with prompt caching, and anti-pattern validation.

Purpose: These components are shared across ALL section generators and ensure consistent voice throughout the newsletter.
Output: Three modules (voice_profile.py, claude_client.py, anti_pattern_validator.py) with tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-newsletter-engine/04-CONTEXT.md
@.planning/phases/04-newsletter-engine/04-RESEARCH.md
@execution/perplexity_client.py (pattern for API clients)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Voice Profile and Anti-Pattern Modules</name>
  <files>
    execution/voice_profile.py
    execution/anti_pattern_validator.py
    tests/test_voice_profile.py
    tests/test_anti_pattern_validator.py
  </files>
  <action>
Create execution/voice_profile.py with:
- VOICE_PROFILE_PROMPT: Complete system prompt (~2000+ tokens) containing:
  - Hormozi/Suby hybrid voice description
  - Sentence rhythm rules (Punch -> Setup -> Land pattern)
  - Word count targets per sentence (8-12 avg, 60% short, 30% medium, 10% long)
  - Anti-patterns list explicitly in the prompt with "NEVER use these phrases"
  - Specificity guidance (concrete numbers when available)
  - Read-out-loud test instruction
- SECTION_GUIDELINES: Dict mapping section names to their specific requirements:
  - section_1: Instant Reward (30-60 words, quote/tweet/stat)
  - section_2: What's Working Now (300-500 words, single actionable tactic)
  - section_3: The Breakdown (200-300 words, story-sell bridge)
  - section_4: Tool of the Week (100-200 words, insider friend energy)
  - section_5: PS Statement (20-40 words, reward reader)

Create execution/anti_pattern_validator.py with:
- ANTI_PATTERNS: List of all 20+ forbidden phrases from CONTEXT.md:
  - "game-changer", "unlock your potential", "leverage", "synergy"
  - "dive deep", "unpack", "at the end of the day"
  - "It's worth noting", "Interestingly enough"
  - "In today's fast-paced world", "In the ever-evolving landscape"
  - "Take it to the next level", "Move the needle"
  - "Circle back", "Touch base", "Low-hanging fruit"
  - "Empower", "Revolutionize", "Transform your business"
  - "Secret sauce", "Silver bullet", "Holy grail"
  - "Crushing it", "Killing it"
  - "I'm excited to share", "I'm thrilled to announce"
  - "Without further ado"
- validate_voice(content: str) -> tuple[bool, list[str]]: Returns (is_valid, violations_list)
- count_sentence_stats(content: str) -> dict: Returns word counts, sentence lengths, rhythm analysis
- Patterns that start sentences ("So,", "Look,") should also be detected

Tests should cover:
- All anti-patterns individually detected
- Clean text passes validation
- Multiple violations detected
- Case-insensitive matching
- Sentence stats calculation accuracy
  </action>
  <verify>
Run `python -m pytest tests/test_voice_profile.py tests/test_anti_pattern_validator.py -v`
All tests pass. Anti-pattern detection catches each phrase.
  </verify>
  <done>
Voice profile prompt is complete (~2000 tokens).
Anti-pattern validator detects all 20+ forbidden phrases.
Tests confirm detection works case-insensitively.
  </done>
</task>

<task type="auto">
  <name>Task 2: Claude Client with Prompt Caching</name>
  <files>
    execution/claude_client.py
    tests/test_claude_client.py
  </files>
  <action>
Create execution/claude_client.py with:
- ClaudeClient class:
  - __init__(self, api_key: str | None = None): Uses ANTHROPIC_API_KEY from env if not provided
  - generate_with_voice(self, prompt: str, max_tokens: int = 1024) -> str:
    - Uses claude-sonnet-4-5 model
    - System prompt is VOICE_PROFILE_PROMPT with cache_control: {"type": "ephemeral"}
    - Returns generated text
    - Logs cache hit/miss stats if available
  - generate_section(self, section_name: str, content: dict, prior_sections: dict = None) -> str:
    - Combines SECTION_GUIDELINES[section_name] with content context
    - Includes prior_sections summary for narrative coherence
    - Validates output with anti_pattern_validator
    - Returns generated section text
    - Raises ValueError if anti-patterns detected (with violations list)

Follow perplexity_client.py pattern:
- Use python-dotenv for env loading
- Error handling for missing API key
- Structured response extraction

DO NOT mock the Anthropic SDK during implementation - just structure the code correctly.
Tests should mock anthropic.Anthropic() to avoid actual API calls.

Tests should cover:
- API key loading from env
- Cache control structure in system prompt
- generate_with_voice returns text content
- generate_section includes prior sections in context
- Anti-pattern validation integration
- Missing API key raises ValueError
  </action>
  <verify>
Run `python -m pytest tests/test_claude_client.py -v`
All tests pass with mocked API responses.
Verify cache_control structure is correct in system prompt.
  </verify>
  <done>
ClaudeClient uses prompt caching for voice profile.
generate_section integrates anti-pattern validation.
Tests verify structure without actual API calls.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_voice_profile.py tests/test_anti_pattern_validator.py tests/test_claude_client.py -v` - All tests pass
2. `grep -r "cache_control" execution/claude_client.py` - Shows ephemeral cache config
3. `grep -c "ANTI_PATTERNS" execution/anti_pattern_validator.py` - Shows list is defined
4. `python -c "from execution.voice_profile import VOICE_PROFILE_PROMPT; print(len(VOICE_PROFILE_PROMPT.split()))"` - Shows ~300+ words
</verification>

<success_criteria>
- Voice profile contains all Hormozi/Suby guidelines from CONTEXT.md
- Anti-patterns list has 20+ forbidden phrases
- Claude client uses prompt caching correctly
- Validation catches anti-patterns in generated text
- All tests pass with mocked API
</success_criteria>

<output>
After completion, create `.planning/phases/04-newsletter-engine/04-01-SUMMARY.md`
</output>
