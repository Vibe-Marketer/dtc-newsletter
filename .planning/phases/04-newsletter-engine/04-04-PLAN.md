---
phase: 04-newsletter-engine
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - execution/subject_line_generator.py
  - execution/newsletter_generator.py
  - directives/newsletter_generate.md
  - tests/test_subject_line_generator.py
  - tests/test_newsletter_generator.py
autonomous: true

must_haves:
  truths:
    - "Subject lines are under 50 characters total"
    - "Subject lines are lowercase after colon"
    - "Preview text hooks reader (not 'view in browser')"
    - "Complete newsletter outputs as markdown"
    - "DOE directive triggers on 'generate newsletter'"
  artifacts:
    - path: "execution/subject_line_generator.py"
      provides: "Subject line and preview text generation"
      exports: ["generate_subject_line", "generate_preview_text", "select_subject_style"]
    - path: "execution/newsletter_generator.py"
      provides: "Full newsletter orchestrator"
      exports: ["generate_newsletter", "NewsletterOutput"]
    - path: "directives/newsletter_generate.md"
      provides: "DOE directive for newsletter generation"
      contains: "DOE-VERSION: 2026.01.31"
  key_links:
    - from: "execution/newsletter_generator.py"
      to: "execution/section_generators.py"
      via: "imports all generate_section_* functions"
      pattern: "from.*section_generators.*import"
    - from: "execution/newsletter_generator.py"
      to: "execution/content_selector.py"
      via: "uses select_content_for_sections"
      pattern: "from.*content_selector.*import"
    - from: "directives/newsletter_generate.md"
      to: "execution/newsletter_generator.py"
      via: "DOE version match"
      pattern: "DOE-VERSION: 2026.01.31"
---

<objective>
Complete the newsletter engine with subject line generation, preview text, full orchestrator, and DOE directive.

Purpose: This plan delivers the complete newsletter generation capability - from aggregated content to Beehiiv-ready markdown.
Output: Full newsletter generator with CLI, subject lines, preview text, and DOE crystallization.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-newsletter-engine/04-CONTEXT.md
@.planning/phases/04-newsletter-engine/04-RESEARCH.md
@.planning/phases/04-newsletter-engine/04-01-SUMMARY.md
@.planning/phases/04-newsletter-engine/04-02-SUMMARY.md
@.planning/phases/04-newsletter-engine/04-03-SUMMARY.md
@directives/content_aggregate.md (DOE pattern reference)
@execution/content_aggregate.py (CLI pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Subject Line and Preview Text Generators</name>
  <files>
    execution/subject_line_generator.py
    tests/test_subject_line_generator.py
  </files>
  <action>
Create execution/subject_line_generator.py with:

SUBJECT_STYLES: dict mapping style names to prompts
- "curiosity": "Create a curiosity-driven hook that makes the reader NEED to open"
- "direct_benefit": "State a specific, concrete benefit with numbers"
- "question": "Ask a question that challenges their assumptions"

select_subject_style(history: list[str] | None = None) -> str:
- Returns "curiosity" (70%), "direct_benefit" (20%), or "question" (10%)
- Uses random.choices with weights
- Optional history parameter for future style tracking

generate_subject_line(issue_number: int, main_topic: str, style: str, client: ClaudeClient) -> str:
- Format: "DTC Money Minute #X: lowercase curiosity hook"
- Hard constraints in prompt:
  - Lowercase after colon
  - Zero emojis
  - No ALL CAPS words
  - Under 50 characters TOTAL
  - Never start hook with "How to"
- Validate output:
  - Length check (<= 50 chars)
  - Lowercase check (after colon)
  - Emoji check (none)
  - If validation fails, regenerate once with stricter prompt
- Return final subject line

validate_subject_line(subject: str, issue_number: int) -> tuple[bool, list[str]]:
- Returns (is_valid, list of violations)
- Checks: length, lowercase, emojis, caps

generate_preview_text(newsletter_content: str, client: ClaudeClient) -> str:
- Generates preview/preheader text (40-90 characters)
- Must be a HOOK, not "View in browser" or generic
- Prompt:
  ```
  <task>Generate email preview text</task>
  <requirements>
  - 40-90 characters
  - Hook that creates curiosity
  - Complements subject line (don't repeat it)
  - NOT "View in browser" or similar
  </requirements>
  <newsletter_summary>{first 200 words}</newsletter_summary>
  <output_format>Preview text only, nothing else</output_format>
  ```
- Validate length (40-90 chars)

Tests should cover:
- Style selection follows 70/20/10 distribution (statistical test)
- Subject line format correct (DTC Money Minute #X:)
- Subject line under 50 chars
- Subject line lowercase after colon
- Subject line no emojis
- Validation catches all violation types
- Regeneration on validation failure
- Preview text is hook (not generic)
- Preview text length 40-90 chars
  </action>
  <verify>
Run `python -m pytest tests/test_subject_line_generator.py -v`
All tests pass. Subject line validation working.
  </verify>
  <done>
Subject lines follow format and 50-char limit.
Style rotation is 70/20/10.
Preview text generates hooks.
Validation catches violations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Newsletter Orchestrator and DOE Directive</name>
  <files>
    execution/newsletter_generator.py
    directives/newsletter_generate.md
    tests/test_newsletter_generator.py
  </files>
  <action>
Create execution/newsletter_generator.py with:

NewsletterOutput dataclass:
- issue_number: int
- subject_line: str
- preview_text: str
- sections: dict[str, str]  # section_1, section_2, etc.
- markdown: str  # Complete formatted output
- metadata: dict  # sources_used, word_counts, generation_time

generate_newsletter(
    aggregated_content: list[dict],
    issue_number: int,
    tool_info: dict | None = None,
    ps_type: str = "foreshadow"
) -> NewsletterOutput:
- Full orchestration:
  1. Initialize ClaudeClient
  2. Select content via select_content_for_sections()
  3. Generate Section 1 (instant reward)
  4. Generate Section 2 (tactical) with Section 1 context
  5. Generate Section 3 (breakdown) with prior context
  6. Generate Section 4 (tool) - uses tool_info or placeholder
  7. Generate Section 5 (PS) with full context
  8. Generate subject line (select style, generate, validate)
  9. Generate preview text
  10. Format as markdown
  11. Return NewsletterOutput

format_as_markdown(output: NewsletterOutput) -> str:
- Combines all sections into Beehiiv-ready markdown
- No section headers (natural flow)
- Includes subject line at top as comment: <!-- Subject: ... -->
- Includes preview text as comment: <!-- Preview: ... -->
- Sections separated by blank lines
- Returns complete markdown string

CLI interface (argparse):
- --content-file: Path to aggregated content JSON (from content_aggregate.py)
- --issue-number: Newsletter issue number (required)
- --tool-name: Name of tool for Section 4
- --tool-description: Description of tool
- --tool-why: Why it helps
- --tool-link: Optional link
- --ps-type: foreshadow | cta | meme (default: foreshadow)
- --output-dir: Output directory (default: output/newsletters/)
- --dry-run: Generate but don't save

Saves output to: output/newsletters/{date}-issue-{number}.md

Create directives/newsletter_generate.md:
- DOE-VERSION: 2026.01.31
- Trigger phrases: "generate newsletter", "create newsletter", "newsletter from content"
- Quick Start: python execution/newsletter_generator.py --content-file data/content_cache/latest.json --issue-number 1
- Documents all CLI options
- Links to execution/newsletter_generator.py

Tests should cover:
- Full orchestration flow (mocked client)
- Content selection integrated
- All 5 sections generated
- Subject line generated and validated
- Preview text generated
- Markdown formatting correct
- CLI argument parsing
- Output file naming
- Handles missing tool_info (uses placeholder)
  </action>
  <verify>
Run `python -m pytest tests/test_newsletter_generator.py -v`
All tests pass.
Verify: `python execution/newsletter_generator.py --help` shows all options.
Verify: DOE version matches in directive and script.
  </verify>
  <done>
Newsletter generator orchestrates full pipeline.
Output is Beehiiv-ready markdown.
DOE directive crystallized with matching version.
CLI supports all required options.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_subject_line_generator.py tests/test_newsletter_generator.py -v` - All tests pass
2. `python execution/newsletter_generator.py --help` - Shows CLI options
3. `grep "DOE-VERSION: 2026.01.31" directives/newsletter_generate.md execution/newsletter_generator.py` - Versions match
4. `grep -r "<!-- Subject:" execution/newsletter_generator.py` - Shows markdown format includes subject
5. Total test count: `python -m pytest tests/ --collect-only | grep "test_" | wc -l` - Shows comprehensive coverage
</verification>

<success_criteria>
- Subject lines under 50 chars, lowercase, no emojis
- Style rotation follows 70/20/10
- Preview text is hook (not generic)
- Full newsletter generates from aggregated content
- Output is Beehiiv-ready markdown
- DOE directive matches script version
- CLI interface complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-newsletter-engine/04-04-SUMMARY.md`
</output>
