---
phase: 04-newsletter-engine
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - execution/section_generators.py
  - tests/test_section_generators.py
autonomous: true

must_haves:
  truths:
    - "Section 3 generates 200-300 word story-sell bridge"
    - "Section 4 has insider friend energy, not pitch"
    - "Section 5 generates 20-40 word PS statement"
    - "All sections flow naturally without headers"
  artifacts:
    - path: "execution/section_generators.py"
      provides: "Complete section generators 1-5"
      exports: ["generate_section_1", "generate_section_2", "generate_section_3", "generate_section_4", "generate_section_5"]
  key_links:
    - from: "execution/section_generators.py"
      to: "execution/claude_client.py"
      via: "all generators use client"
      pattern: "client\\.generate"
---

<objective>
Add section 3, 4, and 5 generators to complete the 5-section newsletter body.

Purpose: Section 3 bridges story to sell. Section 4 is tool recommendation with insider energy. Section 5 is PS statement that trains clicking behavior.
Output: Complete section_generators.py with all 5 sections.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-newsletter-engine/04-CONTEXT.md
@.planning/phases/04-newsletter-engine/04-RESEARCH.md
@.planning/phases/04-newsletter-engine/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Section 3, 4, 5 Generators</name>
  <files>
    execution/section_generators.py
    tests/test_section_generators.py
  </files>
  <action>
Add to execution/section_generators.py:

generate_section_3(content: dict, client: ClaudeClient, prior_sections: dict) -> str:
- Generates "The Breakdown" (200-300 words)
- Story-sell bridge: narrative that leads to lesson
- Ratio of story vs lesson depends on source material
- XML-structured prompt:
  ```
  <task>Generate Section 3: The Breakdown</task>
  <requirements>
  - 200-300 words
  - Story-sell bridge format
  - Match narrative weight to what content supports
  - If source has strong story, lean into narrative
  - If source is more tactical, shorter story + deeper lesson
  </requirements>
  <source_content>{content}</source_content>
  <prior_context>
  Section 1: {prior_sections.get('section_1', 'N/A')[:100]}
  Section 2: {prior_sections.get('section_2', 'N/A')[:200]}
  </prior_context>
  <output_format>Natural paragraph flow, no headers</output_format>
  ```
- Validates word count (200-300 range)

generate_section_4(tool_info: dict, client: ClaudeClient, prior_sections: dict) -> str:
- Generates "Tool of the Week" (100-200 words)
- CRITICAL: Insider friend energy, NEVER a pitch
- Like sharing a secret with close friend
- Should feel "almost illegal" - insider trading vibes
- tool_info contains: name, description, why_it_helps, link (optional), is_affiliate (bool)
- XML-structured prompt:
  ```
  <task>Generate Section 4: Tool of the Week</task>
  <requirements>
  - 100-200 words
  - INSIDER FRIEND ENERGY - like sharing a secret
  - Never gimmicky, salesy, or cliche
  - Should feel "almost illegal" to share
  - If affiliate, still feels like genuine recommendation
  - Natural mention of tool name and what it does
  </requirements>
  <tool_info>
  Name: {tool_info['name']}
  What it does: {tool_info['description']}
  Why it helps: {tool_info['why_it_helps']}
  </tool_info>
  <prior_context>Newsletter so far covers: {summarize prior_sections}</prior_context>
  <output_format>Conversational paragraph, no headers</output_format>
  ```
- Validates word count (100-200 range)

generate_section_5(client: ClaudeClient, prior_sections: dict, ps_type: str = "foreshadow") -> str:
- Generates "PS Statement" (20-40 words)
- Second most-read part after subject line (per Hormozi)
- Purpose: reward reader, train clicking behavior
- ps_type: "foreshadow" | "cta" | "meme"
- XML-structured prompt:
  ```
  <task>Generate Section 5: PS Statement</task>
  <requirements>
  - 20-40 words MAXIMUM
  - Start with "PS:" or "P.S."
  - Type: {ps_type}
    - foreshadow: tease next week's content
    - cta: secondary call to action
    - meme: funny/relatable observation
  - Purpose: reward reader, get them clicking
  </requirements>
  <newsletter_context>{summarize key points from prior_sections}</newsletter_context>
  <output_format>Single PS statement, nothing else</output_format>
  ```
- Validates word count (20-40 range, strict for PS)

Add tests for:
- Section 3 generates with narrative context
- Section 3 validates 200-300 word range
- Section 4 uses tool_info correctly
- Section 4 validates 100-200 word range
- Section 4 prompt includes "insider" language
- Section 5 generates all three ps_types
- Section 5 validates strict 20-40 word range
- Section 5 starts with "PS:" or "P.S."
  </action>
  <verify>
Run `python -m pytest tests/test_section_generators.py -v`
All tests pass. All 5 generators implemented.
  </verify>
  <done>
All 5 section generators complete.
Section 4 has insider friend energy prompting.
Section 5 supports three PS types.
Word count validation for all sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Section Generator Integration Tests</name>
  <files>
    tests/test_section_generators.py
  </files>
  <action>
Add integration-style tests to tests/test_section_generators.py:

Test full section flow:
- test_all_sections_generate_in_sequence():
  - Mock ClaudeClient to return plausible content
  - Generate sections 1-5 in order
  - Verify each section receives prior_sections context
  - Verify word counts are in expected ranges

Test context passing:
- test_section_context_flows_through():
  - Generate section 1
  - Pass to section 2 as prior_sections
  - Verify section 2 prompt includes section 1 summary
  - Continue through section 5

Test error handling:
- test_handles_empty_content():
  - Pass empty content dict
  - Verify graceful handling (raises or returns placeholder)

Test tool_info variations:
- test_section_4_with_affiliate_link():
  - tool_info with is_affiliate=True
  - Verify prompt still emphasizes genuine recommendation

- test_section_4_without_link():
  - tool_info without link field
  - Verify generates correctly

Verify prompt structure:
- test_prompts_use_xml_tags():
  - Capture prompts passed to client
  - Verify XML structure (<task>, <requirements>, etc.)
  </action>
  <verify>
Run `python -m pytest tests/test_section_generators.py -v`
All tests including integration tests pass.
  </verify>
  <done>
Integration tests verify full section flow.
Context passing verified through all sections.
Error handling tested.
XML prompt structure confirmed.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_section_generators.py -v` - All tests pass
2. `grep -c "generate_section_" execution/section_generators.py` - Shows 5 generators
3. `grep -r "insider" execution/section_generators.py` - Shows Section 4 has insider energy prompt
4. `grep -r "PS:" execution/section_generators.py` - Shows Section 5 PS format
</verification>

<success_criteria>
- All 5 section generators implemented
- Section 3 bridges story to lesson
- Section 4 has insider friend energy (not pitch)
- Section 5 supports foreshadow/cta/meme types
- Context flows through all sections
- Word count validation for all sections
</success_criteria>

<output>
After completion, create `.planning/phases/04-newsletter-engine/04-03-SUMMARY.md`
</output>
